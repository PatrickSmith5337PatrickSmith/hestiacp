#!/bin/bash
# info: rebuild mail domains
# options: user
#
# The function rebuilds EXIM configuration files for all mail domains.


#----------------------------------------------------------#
#                    Variable&Function                     #
#----------------------------------------------------------#

# Argument defenition
user=$1

# Includes
source $VESTA/conf/vesta.conf
source $VESTA/func/shared.sh
source $VESTA/func/domain.sh


#----------------------------------------------------------#
#                    Verifications                         #
#----------------------------------------------------------#

check_args '1' "$#" 'user'
validate_format 'user'
is_system_enabled "$MAIL_SYSTEM"
is_object_valid 'user' 'USER' "$user"
is_object_unsuspended 'user' 'USER' "$user"


#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

# Reset counters
U_MAIL_DOMAINS='0'
U_MAIL_ACCOUNTS='0'
SUSPENDED_MAIL='0'
U_DISK_MAIL='0'

# Checking mail folder
if [ ! -d "$USER_DATA/mail" ]; then
    rm -f $USER_DATA/mail
    mkdir $USER_DATA/mail
fi

# Starting loop
for domain in $(search_objects 'dns' 'SUSPENDED' "*" 'DOMAIN'); do

    # Defining variables
    get_domain_values 'mail'

    # Rebuilding config structure
    mkdir -p $HOMEDIR/$user/conf/mail/$domain
    rm -f $HOMEDIR/$user/conf/mail/$domain/aliases
    rm -f $HOMEDIR/$user/conf/mail/$domain/protection
    rm -f $HOMEDIR/$user/conf/mail/$domain/passwd
    touch $HOMEDIR/$user/conf/mail/$domain/aliases
    touch $HOMEDIR/$user/conf/mail/$domain/protection
    touch $HOMEDIR/$user/conf/mail/$domain/passwd
    chown -R root:mail $HOMEDIR/$user/conf/mail/$domain
    chmod 770 $HOMEDIR/$user/conf/mail/$domain
    chmod 660 $HOMEDIR/$user/conf/mail/$domain*

    # Adding antispam protection
    if [ "$ANTISPAM" = 'yes' ]; then
        echo 'antispam' >> $HOMEDIR/$user/conf/mail/$domain/protection
    fi

    # Adding antivirus protection
    if [ "$ANTIVIRUS" = 'yes' ]; then
        echo 'antivirus' >> $HOMEDIR/$user/conf/mail/$domain/protection
    fi

    # Adding dkim
    if [ "$DKIM" = 'yes' ]; then
        pem="$USER_DATA/mail/$domain.pem"
        pub="$USER_DATA/mail/$domain.pub"
        openssl genrsa -out $pem 512 &>/dev/null
        openssl rsa -pubout -in $pem -out $pub &>/dev/null
        chmod 660 $USER_DATA/mail/$domain.*

        cp $pem $HOMEDIR/$user/conf/mail/$domain/dkim.pem
        chown root:mail $HOMEDIR/$user/conf/mail/$domain/dkim.pem
        chmod 660 $HOMEDIR/$user/conf/mail/$domain/dkim.pem

        # Deleting old dkim records
        records=$($BIN/v_list_dns_domain_records $user $domain plain)
        dkim_records=$(echo "$records" |grep -w '_domainkey'|cut -f 1 -d ' ')
        for id in $dkim_records; do
            $BIN/v_delete_dns_domain_record $user $domain $id
        done

        # Adding dkim dns records
        check_dns_domain=$(is_object_valid 'dns' 'DOMAIN' "$domain")
        if [ "$?" -eq 0 ]; then
            p=$(cat $pub|grep -v ' KEY---'|tr -d '\n')
            record='_domainkey'
            policy="\"t=y; o=~;\""
            $BIN/v_add_dns_domain_record $user $domain $record TXT "$policy"

            record='mail._domainkey'
            slct="\"k=rsa\; p=$p\""
            $BIN/v_add_dns_domain_record $user $domain $record TXT "$slct"
        fi
    fi

    # Adding antispam protection
    if [ "$SUSPENDED" != 'yes' ]; then
        ln -s $HOMEDIR/$user/conf/mail/$domain /etc/exim/domains/
    fi

    if [ ! -e $HOMEDIR/$user/mail/$domain ]; then
        mkdir $HOMEDIR/$user/mail/$domain
    fi
    chown $user:mail $HOMEDIR/$user/mail/$domain
    chmod 770 $HOMEDIR/$user/mail/$domain

    # Rebuild counters
    U_MAIL_DOMAINS=$((U_MAIL_DOMAINS + 1))
    U_DISK_MAIL=$((U_DISK_MAIL + U_DISK))
done


#----------------------------------------------------------#
#                       Vesta                              #
#----------------------------------------------------------#

# Updating counters
U_MAIL_DOMAINS='0'
U_MAIL_ACCOUNTS='0'
SUSPENDED_MAIL='0'
U_DISK_MAIL='0'

update_user_value "$user" '$U_MAIL_DOMAINS' "$U_MAIL_DOMAINS"
update_user_value "$user" '$U_MAIL_ACCOUNTS' "$U_MAIL_ACCOUNTS"
update_user_value "$user" '$SUSPENDED_MAIL' "$SUSPENDED_MAIL"
update_user_value "$user" '$U_DISK_MAIL' "$U_DISK_MAIL"

# Logging
log_event "$OK" "$EVENT"

exit
