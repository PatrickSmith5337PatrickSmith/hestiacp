#!/bin/bash
# info: add mail account alias aka nickname
# options: user domain account alias
#
# The function add new email account.


#----------------------------------------------------------#
#                    Variable&Function                     #
#----------------------------------------------------------#

# Argument defenition
user=$1
domain=$(idn -t --quiet -u "$2" )
domain=$(echo $domain | tr '[:upper:]' '[:lower:]')
domain_idn=$(idn -t --quiet -a "$domain")
account=$3
malias=$4

# Importing variables
source $VESTA/conf/vesta.conf
source $VESTA/func/shared.sh
source $VESTA/func/domain.sh


#----------------------------------------------------------#
#                    Verifications                         #
#----------------------------------------------------------#
check_args '4' "$#" 'user domain account alias'
validate_format 'user' 'domain' 'account' 'malias'
is_system_enabled 'MAIL_SYSTEM'
is_object_valid 'user' 'USER' "$user"
is_object_unsuspended 'user' 'USER' "$user"
is_object_valid 'mail' 'DOMAIN' "$domain"
is_object_unsuspended 'mail' 'DOMAIN' "$domain"
is_object_valid "mail/$domain" 'ACCOUNT' "$account"
is_object_unsuspended "mail/$domain" 'ACCOUNT' "$account"
is_key_empty "mail/$domain" '' '$AUTOREPLY'
exit

#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#
exit
# Adding exim alias
str="$mailas@$domain:$account@$domain"
echo "$str" >> $HOMEDIR/$user/conf/mail/$domain/aliases


#----------------------------------------------------------#
#                       Vesta                              #
#----------------------------------------------------------#

# Adding vesta alias
aliases=$(get_domain_value "mail/$domain" '$ALIAS' "ACCOUNT='$account'")
if [ -z "$aliases" ]; then
    aliases="$malias"
else
    aliases="$aliases,$malias"
fi
update_domain_value "mail/$domain" '$ALIAS' "$aliases" "ACCOUNT='$account'"

# Logging
cmd='v_delete_mail_account_alias'
log_history "$EVENT" "$cmd $user $domain $account $malias"
log_event "$OK" "$EVENT"

exit
