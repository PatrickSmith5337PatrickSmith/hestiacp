#!/bin/bash
# info: rebuild dns domains
# options: user
#
# The function rebuilds BIND configuration files for all dns domains.


#----------------------------------------------------------#
#                    Variable&Function                     #
#----------------------------------------------------------#

# Argument defenition
user=$1

# Importing variables
source $VESTA/conf/vesta.conf
source $VESTA/func/shared.sh
source $VESTA/func/domain.sh
source $VESTA/func/ip.sh


#----------------------------------------------------------#
#                    Verifications                         #
#----------------------------------------------------------#

# Checking arg number
check_args '1' "$#" 'user'

# Checking argument format
validate_format 'user'

# Checking dns system is enabled
is_system_enabled 'DNS_SYSTEM'

# Checking user
is_object_valid 'user' 'USER' "$user"

# Checking user is active
is_object_suspended 'user' 'USER' "$user"


#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

user_domains=0
user_records=0
suspended_dns=0

# Checking dns folder
if [ ! -d "$USER_DATA/dns" ]; then
    rm -f $USER_DATA/dns
    mkdir $USER_DATA/dns
fi

# Defining config
conf="$USER_DATA/dns.conf"

# Defining search string
search_string="DOMAIN"

# Defining fileds to select
field='$DOMAIN'

# Parsing unsuspeneded domains
domains=$(dom_clear_search)

# Defining user name servers
ns=$(get_user_value '$NS')
i=1
for nameserver in ${ns//,/ };do
    eval ns$i="$nameserver"
    i=$((i + 1))
done

# Starting loop
for domain in $domains; do

    # Defining variables
    get_domain_values 'dns'
    domain_idn=$(idn -t --quiet -a "$domain")

    # Checking zone file
    if [ ! -e "$USER_DATA/dns/$domain" ]; then
        cat $DNSTPL/$TPL.tpl |\
            sed -e "s/%ip%/$IP/g" \
                -e "s/%domain_idn%/$domain_idn/g" \
                -e "s/%domain%/$domain/g" \
                -e "s/%ns1%/$ns1/g" \
                -e "s/%ns2%/$ns2/g" \
                -e "s/%ns3%/$ns3/g" \
                -e "s/%ns4%/$ns4/g" \
                -e "s/%ns5%/$ns5/g" \
                -e "s/%ns6%/$ns6/g" \
                -e "s/%ns7%/$ns7/g" \
                -e "s/%ns8%/$ns8/g" \
                -e "s/%date%/$DATE/g" > $USER_DATA/dns/$domain
    fi

    # Sorting records
    sort_dns_records

    # Updating zone
    conf="$HOMEDIR/$user/conf/dns/$domain.db"
    update_domain_zone

    chmod 640 $conf
    chown root:named $conf

    # Bind config check
    nconf='/etc/named.conf'

    if [ "$SUSPENDED" = 'yes' ]; then
	rm_string=$(grep -n /etc/namedb/$domain.db $nconf | cut -d : -f 1)
        if [ ! -z "$rm_string" ]; then
            sed -i "$rm_string d" $nconf
        fi
        suspended_dns=$((suspended_dns + 1))
    else
	if [ -z "$(grep /$domain.db $nconf)" ]; then
            named="zone \"$domain_idn\" {type master; file"
            named="$named \"$HOMEDIR/$user/conf/dns/$domain.db\";};"
            echo "$named" >> /etc/named.conf
        fi
    fi
    user_domains=$((user_domains + 1))
    records=$(wc -l $USER_DATA/dns/$domain | cut -f 1 -d ' ')
    user_records=$((user_records + records))
    update_domain_value 'dns' '$RECORDS' "$records"
done


#----------------------------------------------------------#
#                       Vesta                              #
#----------------------------------------------------------#

# Updating counters
update_user_value "$user" '$U_DNS_DOMAINS' "$user_domains"
update_user_value "$user" '$U_DNS_RECORDS' "$user_records"
update_user_value "$user" '$SUSPENDED_DNS' "$suspended_dns"

# Adding task to the vesta pipe
$BIN/v_restart_dns

# Logging
log_event "$OK" "$EVENT"

exit
