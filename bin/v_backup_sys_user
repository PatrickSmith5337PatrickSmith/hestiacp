#!/bin/bash
# info: backup system user with all its objects

#----------------------------------------------------------#
#                    Variable&Function                     #
#----------------------------------------------------------#

# Argument defenition
user="$1"
output="$2"

# Importing variables
source $VESTA/conf/vars.conf
source $V_FUNC/shared_func.sh
source $V_FUNC/domain_func.sh
source $V_FUNC/db_func.sh
source $V_CONF/vesta.conf


#----------------------------------------------------------#
#                    Verifications                         #
#----------------------------------------------------------#

# Checking arg number
check_args '1' "$#" 'user [output]'

# Checking argument format
format_validation 'user'

# Checking backup system is enabled
is_system_enabled 'backup'

# Checking user
is_user_valid

# Checking user backups
is_backup_enabled

# Checking load averages
la=$(cat /proc/loadavg |cut -f 1 -d ' '|cut -f 1 -d '.')
i=0
while [ "$la" -ge "$V_BACKUP_LA_LIMIT" ]; do
    if [ -z "$output" ]; then
        echo "$(date +%m-%d-%y" "%H:%m:%S) Load Average $la"
        echo
    fi

    sleep 60

    if [ "$i" -ge "15" ]; then
        echo "Error: LA is too high"
        log_event 'debug' "$E_LOAD_AVERAGE $V_EVENT"
        exit $E_LOAD_AVERAGE
    fi

    i=$((i + 1))
done


#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

# Creating temporary random directory
tmpdir=$(mktemp -p $V_TMP -d)

# Prinitng status
if [ -z "$output" ]; then
    echo "$(date +%m-%d-%y" "%H:%m:%S) System backup for user $user"
    echo "TMPDIR is $tmpdir"
    echo
fi

# Addding vesta version
echo "1.0" >$tmpdir/backup_version
echo "$VERSION" > $tmpdir/vesta_version

# Checking excludes
OLD_IFS="$IFS"
IFS=$'\n'
if [ -e "$V_USERS/$user/backup.excludes" ]; then
    if [ -z "$output" ]; then
        echo "-- Excludes --"
    fi

    for exclude in $(cat $V_USERS/$user/backup.excludes); do
        if [ -z "$output" ]; then
            echo -e "\t $exclude"
        fi
        # Indirect variable references (a bit of black magic)
        eval ${exclude%%=*}=${exclude#*=}
    done

    if [ -z "$output" ]; then
        echo
    fi
fi
IFS="$OLD_IFS"

# WEB domains
if [ ! -z "$WEB_SYSTEM" ] && [ "$WEB_SYSTEM" != 'no' ] && [ "$WEB" != '*' ]
then
    if [ -z "$output" ]; then
        echo "-- WEB --"
    fi
    mkdir $tmpdir/web/

    # Parsing unsuspeneded domains
    conf="$V_USERS/$user/web.conf"
    field='$DOMAIN'
    search_string='DOMAIN='
    domains=$(dom_clear_search)
    domain_list=''

    # Cleaning excludes
    for domain in $domains; do
	check_exl=$(echo "$WEB"|grep -w $domain)
        if [ -z "$check_exl" ]; then
            web_list="$web_list $domain"
        fi
    done

    for domain in $web_list; do
        if [ -z "$output" ]; then
            echo -e "\t$(date +%H:%m:%S) $domain"
        fi

        # Defining domain variables
        domain_idn=$(idn -t --quiet -a "$domain")
        tpl_name=$(get_web_domain_value '$TPL')
        ssl_cert=$(get_web_domain_value '$SSL_CERT')
        nginx=$(get_web_domain_value '$NGINX')

	# Building directory tree
        mkdir -p $tmpdir/web/$domain/conf $tmpdir/web/$domain/cert

        # Packing data folders
        cd $V_HOME/$user/web/$domain
        tar -cf $tmpdir/web/$domain/$domain.tar \
            public_html public_shtml private document_errors cgi-bin stats

        # Creating web.config
        cd $tmpdir/web/$domain/
        conf="$V_USERS/$user/web.conf"
        grep "DOMAIN='$domain'" $conf > conf/web.conf

        # Apache config
        if [ "$WEB_SYSTEM" = 'apache' ]; then
            # Parsing httpd.conf
            tpl_file="$V_WEBTPL/apache_$tpl_name.tpl"
            conf="$V_HOME/$user/conf/httpd.conf"
            get_web_config_brds
            sed -n "$top_line,$bottom_line p" $conf > conf/httpd.conf

            # SSL check
            if [ ! -z "$ssl_cert" ]; then
                tpl_file="$V_WEBTPL/apache_$tpl_name.stpl"
                conf="$V_HOME/$user/conf/shttpd.conf"
                get_web_config_brds
                sed -n "$top_line,$bottom_line p" $conf > conf/shttpd.conf
            fi
        fi

        # Nginx config
        if [ ! -z "$nginx" ] ; then
            tpl_file="$V_WEBTPL/ngingx_vhost_$nginx.tpl"
            conf="$V_HOME/$user/conf/nginx.conf"
            get_web_config_brds
            sed -n "$top_line,$bottom_line p" $conf > conf/nginx.conf

            # SSL check
            if [ ! -z "$ssl_cert" ] ; then
                tpl_file="$V_WEBTPL/ngingx_vhost_$nginx.stpl"
                conf="$V_HOME/$user/conf/snginx.conf"
                get_web_config_brds
                sed -n "$top_line,$bottom_line p" $conf > conf/snginx.conf
            fi
        fi

        # Suplemental configs
        for sconfig in $(ls $V_HOME/$user/conf/|grep ".$domain.conf"); do
            cp $V_HOME/$user/conf/$sconfig conf/
        done

        # SSL Certificates
        if [ ! -z "$ssl_cert" ] ; then
            cp $V_HOME/$user/conf/$ssl_cert.* cert/
        fi

        tar -rf $tmpdir/web/$domain/$domain.tar conf cert
        mv $tmpdir/web/$domain/$domain.tar $tmpdir/web/
        rm -rf $tmpdir/web/$domain

        if [ ! -z "$V_BACKUP_GZIP" ]; then 
            gzip -$V_BACKUP_GZIP $tmpdir/web/$domain.tar
        fi

    done
    if [ -z "$output" ]; then
        echo
    fi

fi

# DNS domains
if [ ! -z "$DNS_SYSTEM" ] && [ "$DNS_SYSTEM" != 'no' ] && [ "$DNS" != '*' ]
then
    if [ -z "$output" ]; then
        echo "-- DNS --"
    fi
    mkdir $tmpdir/dns/

    # Parsing unsuspeneded domains
    conf="$V_USERS/$user/dns.conf"
    field='$DOMAIN'
    search_string='DOMAIN='
    domains=$(dom_clear_search)

    # Cleaning excludes
    for domain in $domains; do
	check_exl=$(echo "$DNS"|grep -w $domain)
        if [ -z "$check_exl" ]; then
            dns_list="$dns_list $domain"
        fi
    done

    for domain in $dns_list; do
        if [ -z "$output" ]; then
            echo -e "\t$(date +%H:%m:%S) $domain"
        fi

        # Building directory tree
        mkdir $tmpdir/dns/$domain

        # Creating dns_domains config
        cd $tmpdir/dns/$domain/
        conf="$V_USERS/$user/dns.conf"
        grep "DOMAIN='$domain'" $conf > dns.conf

        # Backingup dns recods
        cp $V_USERS/$user/zones/$domain $domain
        cp /etc/namedb/$domain.db $domain.db
    done

    if [ -z "$output" ]; then
        echo
    fi
fi


# Mail domains
# TBD

# DatbaBases
if [ ! -z "$DB_SYSTEM" ] && [ "$DB_SYSTEM" != 'no' ] && [ "$DB" != '*' ]; then
    if [ -z "$output" ]; then
        echo "-- DB --"
    fi
    mkdir $tmpdir/db/

    # Parsing unsuspeneded domains
    conf="$V_USERS/$user/db.conf"
    field='$DB'
    search_string='DB='
    dbs=$(dom_clear_search)

    # Cleaning excludes
    for database in $dbs; do
	check_exl=$(echo "$DB"|grep -w $database)
        if [ -z "$check_exl" ]; then
            db_list="$db_list $database"
        fi
    done

    for database in $db_list; do
        type=$(get_db_value '$TYPE')
        host=$(get_db_value '$HOST')
        db_user=$(get_db_value '$USER')
        dump="$tmpdir/db/$database.$type.sql"
        grants="$tmpdir/db/$database.$type.$db_user"

        if [ -z "$output" ]; then
            echo -e "\t$(date +%H:%m:%S) $database $type"
        fi

        case $type in
            mysql) dump_db_mysql ;;
            pgsql) dump_db_pgsql ;;
        esac

        if [ ! -z "$V_BACKUP_GZIP" ]; then 
            gzip -$V_BACKUP_GZIP $dump
        fi

    done

    if [ -z "$output" ]; then
        echo
    fi

fi

# Cron jobs
if [ ! -z "$CRON_SYSTEM" ] && [ "$CRON_SYSTEM" != 'no' ] && [ "$CRON" != '*' ]
then
    if [ -z "$output" ]; then
        echo "-- CRON --"
    fi
    mkdir $tmpdir/cron/

    # Backingup cron recods
    if [ -z "$output" ]; then
        echo -e "\t$(date +%H:%m:%S) cron.conf"
    fi
    cp $V_USERS/$user/cron.conf $tmpdir/cron/

    if [ -z "$output" ]; then
        echo -e "\t$(date +%H:%m:%S) system cron"
    fi

    if [ -e "/var/spool/cron/$user" ]; then
        cp /var/spool/cron/$user $tmpdir/cron/
    fi

    if [ -z "$output" ]; then
        echo
    fi

fi

# SSL CERTIFICATES
if [ ! -z "$WEB_SSL" ] && [ "$WEB_SSL" != 'no' ] && [ "$SSL" != '*' ]; then
    if [ -z "$output" ]; then
        echo "-- CERTIFICATES --"
    fi
    mkdir $tmpdir/cert

    # Backingup ssl certificates
    for cert in $(ls $V_USERS/$user/cert/); do
        if [ -z "$output" ]; then
            echo -e "\t$(date +%H:%m:%S) $cert"
        fi
        cp $V_USERS/$user/cert/$cert $tmpdir/cert/
    done

    if [ -z "$output" ]; then
        echo
    fi

fi

# Vesta
if [ -z "$output" ]; then
    echo "-- VESTA --"
fi
mkdir $tmpdir/vesta

# Backingup vesta configs
if [ -z "$output" ]; then
    echo -e "\t$(date +%H:%m:%S) user.conf"
fi
cp -r $V_USERS/$user/user.conf $tmpdir/vesta/

if [ -e "$V_USERS/$user/billing.log" ]; then
    if [ -z "$output" ]; then
        echo -e "\t$(date +%H:%m:%S) billing.log"
    fi
    cp -r $V_USERS/$user/billing.log $tmpdir/vesta/
fi

if [ -e "$V_USERS/$user/child.conf" ]; then
    if [ -z "$output" ]; then
        echo -e "\t$(date +%H:%m:%S) child.conf"
    fi

    cp -r $V_USERS/$user/child.conf $tmpdir/vesta/
fi

if [ -e "$V_USERS/$user/history.log" ]; then
    if [ -z "$output" ]; then
        echo -e "\t$(date +%H:%m:%S) history.log"
    fi

    cp -r $V_USERS/$user/history.log $tmpdir/vesta/
fi

if [ -e "$V_USERS/$user/backup.excludes" ]; then
    if [ -z "$output" ]; then
        echo -e "\t$(date +%H:%m:%S) backup.excludes"
    fi
    cp -r $V_USERS/$user/backup.excludes $tmpdir/vesta/
fi

if [ -z "$output" ]; then
    echo
fi

# Defining local storage function
local_backup(){
    if [ -z "$output" ]; then
        echo "-- STORAGE --"
        echo -e "\t$(date +%H:%m:%S) ARCHIVE $V_BACKUP/$user.$V_DATE.tar"
    fi

    # Checking retention
    archives=$(ls -lrt $V_BACKUP/ |awk '{print $9}' |grep "^$user\.")
    archives_q=$(echo "$archives" |wc -l)
    if [ "$archives_q" -ge "$backups" ]; then
        archives_r=$((archives_q - backups))
        for archive in $(echo "$archives" | head -n $archives_r); do
            # Removing old archives
            if [ -z "$output" ]; then
                echo -e "\tRemoving old $archive"
            fi
            rm -f $V_BACKUP/$archive
        done
    fi

    # Checking disk space
    disk_usage=$(df $V_BACKUP | awk '{print $5}'|tail -n1|cut -f 1 -d '%')
    if [ "$disk_usage" -ge "$V_BACKUP_DISK_LIMIT" ]; then
        echo "Error: Not enough disk space"
        log_event 'debug' "$E_DISK_SPACE $V_EVENT"
        exit $E_DISK_SPACE
    fi

    # Creating final tarball
    cd $tmpdir
    tar -cf $V_BACKUP/$user.$V_DATE.tar .
    chmod 640 $V_BACKUP/$user.$V_DATE.tar
    chown root:$user $V_BACKUP/$user.$V_DATE.tar

    localbackup='yes'

    if [ -z "$output" ]; then
        echo
    fi
}


# Defining ftp command function
ftpc() {
    ftp -n $HOST $PORT <<EOF
    quote USER $USER
    quote PASS $PASSWORD
    binary
    cd $BPATH
    $1
    quit
EOF
}

# Defining ftp storage function
ftp_backup(){
    if [ -z "$output" ]; then
        echo "-- FTP --"
    fi

    # Checking config
    if [ -e "$V_CONF/backup.conf" ]; then
	ftphost_str=$(grep "TYPE='FTP'" $V_CONF/backup.conf |head -n 1)
    fi

    # Parsing config values
    if [ ! -z "$ftphost_str" ]; then
        for key in $ftphost_str; do
            eval ${key%%=*}=${key#*=}
        done
    else
        echo "Error: Parsing error"
        log_event 'debug' "$E_PARSE_ERROR $V_EVENT"
        exit $E_PARSE_ERROR
    fi

    # Debug info
    if [ -z "$output" ]; then
        echo -e "\t$(date +%H:%m:%S) ftp://$USER@$HOST$BPATH/$user.$V_DATE.tar"
    fi

    # Checking ftp permission
    ftmpdir=$(mktemp -u -p $BPATH)
    command="mkdir $ftmpdir
             ls $ftmpdir
             rm $ftmpdir"
    if [ ! -z "$(ftpc "$command")" ] ; then
        echo "Error: FTP error"
        log_event 'debug' "$E_FTP_ERROR $V_EVENT"
        exit $E_FTP_ERROR
    fi

    # Checking retention
    archives=$(ftpc "ls" |awk '{print $9}' |grep "^$user\.")
    archives_q=$(echo "$archives" | wc -l)
    if [ "$archives_q" -ge "$backups" ]; then
        # Removing old backups
        archives_r=$((archives_q - backups))
        for archive in $(echo "$archives" | tail -n $archives_r); do 
            if [ -z "$output" ]; then
                echo -e "\tRemoving old $archive"
            fi
            ftpc "delete $archive"
        done
    fi

    # Uploading backup archive
    if [ "$localbackup" = 'yes' ]; then
        cd $V_BACKUP
	ftpc "put $user.$V_DATE.tar"
    else
	cd $tmpdir
        tar -cf $V_TMP/$user.$V_DATE.tar .
        cd $V_TMP/
	ftpc "put $user.$V_DATE.tar"
        rm -f $user.$V_DATE.tar
    fi

    if [ -z "$output" ]; then
        echo
    fi
}

# Switching on backup system types
for backup_type in $(echo -e "${BACKUP_SYSTEM//,/\n}"); do
    case $backup_type in
        local) local_backup ;;
        ftp)   ftp_backup ;;
    esac
done

# Removing tmpdir
cd /
rm -rf $tmpdir

if [ -z "$output" ]; then
    echo "$(date +'%m-%d-%y %H:%m:%S')"
    echo
    echo
fi


#----------------------------------------------------------#
#                       Vesta                              #
#----------------------------------------------------------#


# Logging
log_event 'system' "$V_EVENT"

exit $OK
