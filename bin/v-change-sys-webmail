#!/bin/bash
# info: change webmail alias url
# options: WEBMAIL
#
# This function changes the webmail url in apache2 or nginx configuration.


#----------------------------------------------------------#
#                    Variable&Function                     #
#----------------------------------------------------------#

# Argument definition
WEBMAIL=$1

# Includes
source $HESTIA/func/main.sh
source $HESTIA/conf/hestia.conf

# Get existing system webmail alias
export $WEBMAIL_ALIAS

# Define aliases
OLD_ALIAS=$WEBMAIL_ALIAS
NEW_ALIAS=$1

#----------------------------------------------------------#
#                    Verifications                         #
#----------------------------------------------------------#

check_args '1' "$#" 'WEBMAIL'

#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

# Delete old webmail configuration
for user in `ls /usr/local/hestia/data/users/`; do
    for domain in $($BIN/v-list-web-domains $user plain |cut -f 1); do
        $BIN/v-delete-webmail $user $domain
    done
done

# Set new webmail alias
sed -i "s|WEBMAIL_ALIAS='$OLD_ALIAS'|WEBMAIL_ALIAS='$NEW_ALIAS'|gI" $HESTIA/conf/hestia.conf

for user in `ls /usr/local/hestia/data/users/`; do
    for domain in $($BIN/v-list-web-domains $user plain |cut -f 1); do
        echo "Changing webmail alias for $domain"
        $BIN/v-add-webmail $user $domain
    done
done

# Update alias (non-subdomain) configuration to match
sed -i "s|Alias \/webmail|Alias \/$NEW_ALIAS|gI" /etc/apache2/conf.d/roundcube.conf
sed -i "s|location \/webmail|location \/$NEW_ALIAS|gI" /etc/nginx/conf.d/webmail.inc

#----------------------------------------------------------#
#                       Hestia                             #
#----------------------------------------------------------#

# Restart services
$BIN/v-restart-web $restart
$BIN/v-restart-proxy $restart

# Logging
log_history "changed system webmail alias to $NEW_ALIAS"
log_event "$OK" "$ARGUMENTS"

exit
