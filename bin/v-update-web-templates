#!/bin/bash
# info: update web templates
# options: [RESTART]
#
# The function for obtaining updated pack of web templates.


#----------------------------------------------------------#
#                    Variable&Function                     #
#----------------------------------------------------------#

# Argument definition
restart=$1

# Includes
source $HESTIA/func/main.sh
source $HESTIA/conf/hestia.conf

# Detect OS
case $(head -n1 /etc/issue | cut -f 1 -d ' ') in
    Debian)     type="debian" ;;
    Ubuntu)     type="ubuntu" ;;
    *)          type="NoSupport" ;;
esac

# Detect version
if [ "$type" = "ubuntu" ] || [ "$type" = "debian" ]; then
    type="deb"
else
    echo "Error: can't detect supported os"
    log_event "$E_NOTEXIST"
    exit $E_NOTEXIST
fi


#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

# Update templates
cp -rf $HESTIA/install/$type/templates/web $HESTIA/data/templates/

# Update Multi-PHP templates
php_versions=$(ls /etc/php/*/fpm -d 2>/dev/null | wc -l)
if [ "$php_versions" -gt 1 ]; then
    if [ "$WEB_SYSTEM" = "nginx" ]; then
        for tplname in $(ls $HESTIA/data/templates/web/$WEB_SYSTEM/ | grep -v 'default'); do
            rm -fr $HESTIA/data/templates/web/$WEB_SYSTEM/$tplname
        done
    fi
    for v in $(ls /etc/php/); do
        if [ ! -d "/etc/php/$v/fpm/pool.d/" ]; then
            continue
        fi
        v_tpl=$(echo "$v" | sed -e 's/[.]//')
        cp -f $HESTIA/install/$type/multiphp/$WEB_SYSTEM/PHP-$v_tpl.* $HESTIA/data/templates/web/$WEB_SYSTEM/
    done
    chmod a+x $HESTIA/data/templates/web/$WEB_SYSTEM/*.sh
fi

# Rebuilding web domains
for user in $($BIN/v-list-sys-users plain); do
    $BIN/v-rebuild-web-domains $user no
done


#----------------------------------------------------------#
#                       Hestia                             #
#----------------------------------------------------------#

# Restarting web server
$BIN/v-restart-web $restart
check_result $? "restart" >/dev/null 2>&1

$BIN/v-restart-proxy $restart
check_result $? "restart" >/dev/null 2>&1

$BIN/v-restart-proxy $restart
check_result $? "restart" >/dev/null 2>&1

exit
