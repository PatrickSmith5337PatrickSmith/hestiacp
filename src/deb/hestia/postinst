#!/bin/bash

# Get package version
version=$(dpkg -l | awk '$2=="hestia" { print $3 }')

# Define global variables
source /usr/local/hestia/func/main.sh

# Load message variables
source /usr/local/hestia/install/upgrade/messages.sh

# Run triggers only on updates
if [ ! -e "/usr/local/hestia/data/users/admin" ]; then
    exit
fi

# Set backup folder
HESTIA_BACKUP="/root/hst_upgrade/$(date +%d%m%Y%H%M)"

# Intiialize backup folders
mkdir -p $HESTIA_BACKUP/conf/
mkdir -p $HESTIA_BACKUP/packages/
mkdir -p $HESTIA_BACKUP/templates/

# Set installation source folder
hestiacp="$HESTIA/install/deb"

# Clear the screen from apt output to prepare for upgrade installer experience
clear
welcome_message

# Load hestia.conf
source /usr/local/hestia/conf/hestia.conf

# Perform necessary upgrade steps
source /usr/local/hestia/install/upgrade/version.sh

# Upgrade phpMyAdmin if applicable
if [ "$DB_SYSTEM" = 'mysql' ]; then
    source /usr/local/hestia/install/upgrade/phpmyadmin.sh
fi

# Set new version
sed -i "/VERSION/d" $HESTIA/conf/hestia.conf
echo "VERSION='$version'" >> $HESTIA/conf/hestia.conf

# Add upgrade notification to admin user's panel
$HESTIA/bin/v-add-user-notification admin 'Upgrade complete' 'Your server has been updated to '$version'.<br>Please report any bugs on GitHub at<br><a href="https://github.com/hestiacp/hestiacp/Issues" target="_new">https://github.com/hestiacp/hestiacp/Issues</a><br><br>Have a great day!'

# Restart services for changes to take full effect
source /usr/local/hestia/install/upgrade/restart.sh

# Display completion message
upgrade_complete

exit 0
